services:
  scylla:
    image: scylladb/scylla:6.1
    container_name: scylla
    command: ["--smp", "2", "--memory", "2G", "--overprovisioned", "1"]
    ports:
      - "9042:9042"   # CQL
      - "9180:9180"   # Metrics/REST
    volumes:
      - scylla-data:/var/lib/scylla
      - ./backup:/backup
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "DESCRIBE KEYSPACES"]
      interval: 10s
      timeout: 5s
      retries: 20

  scylla-init:
    image: scylladb/scylla:6.1
    container_name: scylla-init
    depends_on:
      scylla:
        condition: service_healthy
    volumes:
      - ./infra/scylla:/cql:ro
    entrypoint: ["bash", "-lc"]
    command: >-
      "cqlsh scylla 9042 -f /cql/schema.cql && 
       echo 'Schema created'"
    restart: "no"

  scylla-load-hotels:
    image: scylladb/scylla:6.1
    container_name: scylla-load-hotels
    depends_on:
      scylla-init:
        condition: service_completed_successfully
    volumes:
      - ./infra/scylla:/cql:ro
      - ./data:/data:ro
    entrypoint: ["bash", "-lc"]
    command: >-
      "cqlsh scylla 9042 -f /cql/load_hotels.cql"
    restart: "no"

  # Optional: very large import (~90M rows). Enable and run intentionally.
  # scylla-load-offers:
  #   image: scylladb/scylla:6.1
  #   container_name: scylla-load-offers
  #   depends_on:
  #     scylla-init:
  #       condition: service_completed_successfully
  #   volumes:
  #     - ./infra/scylla:/cql:ro
  #     - ./data:/data:ro
  #   entrypoint: ["bash", "-lc"]
  #   command: >-
  #     "cqlsh scylla 9042 -f /cql/load_offers.cql"
  #   restart: "no"

  frontend:
    build:
      context: ./default-frontend
      dockerfile: Dockerfile
      target: dev
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: prod
    depends_on:
      scylla-init:
        condition: service_completed_successfully
    ports:
      - "8090:8090"
    environment:
      - GO_ENV=production
      - DATABASE_URL=scylla
      - SCYLLA_HOSTS=scylla
      - SCYLLA_KEYSPACE=holidays

volumes:
  scylla-data:
    driver: local
